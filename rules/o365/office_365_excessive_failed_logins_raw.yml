title: Office 365 Excessive Failed Logins (Raw Query Example)
name: office_365_excessive_failed_logins_raw
id: a4b7c8d9-1234-5678-90ab-cdef12345678
status: experimental
date: 2025-08-11
logsource:
    product: o365
    service: o365 monitoring
    category: web
# Note: No detection field since we're using raw_query
platforms:
    elastic:
        query_language: esql
        raw_query: |
            FROM {{index}}
            | WHERE @timestamp > NOW() - INTERVAL 1 HOUR
              AND o365.audit.Operation == "UserLoginFailed"
              AND o365.audit.ResultStatus == "Failed"
            | STATS failed_count = COUNT(*) BY o365.audit.UserId, source.ip
            | WHERE failed_count > 5
            | SORT failed_count DESC

tests:
    platforms:
        elastic:
            timeframe: 30d
            false_positive_threshold: 10
            true_positive_test_raw:
                hits: 2
                attack_data:
                    data: '[{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:00:00Z"},{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:01:00Z"},{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:02:00Z"},{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:03:00Z"},{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:04:00Z"},{"o365":{"audit":{"UserId":"john.doe@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.100"},"@timestamp":"2025-08-11T10:05:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:10:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:11:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:12:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:13:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:14:00Z"},{"o365":{"audit":{"UserId":"jane.smith@example.com","Operation":"UserLoginFailed","ResultStatus":"Failed"}},"source":{"ip":"192.168.1.101"},"@timestamp":"2025-08-11T10:15:00Z"}]'
                    type: raw
                    source: o365.audit

description: 'This is an example of a raw ESQL query that bypasses Sigma conversion while maintaining all other pteroDaCtyl features. The query detects excessive failed login attempts (more than 5) from the same user and IP address within an hour. The {{index}} placeholder will be replaced with the appropriate index pattern based on the environment configuration (e.g., logs-o365-*-acme for ACME environment).'
author: Example Author

falsepositives:
    - Users legitimately forgetting passwords
    - Password reset attempts
    - Automated tools testing credentials
level: medium
tags:
    - attack.t1110.001  # Brute Force: Password Guessing
    - attack.t1078      # Valid Accounts
references:
    - https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/

suppression:
    group_by:
        - o365.audit.UserId
        - source.ip
    duration:
        value: 10
        unit: m
    missing_fields_strategy: suppress

environments:
    acme:
        level: high
        suppression:
            duration:
                value: 15
                unit: m
    ecorp:
        level: critical
        suppression:
            duration:
                value: 5
                unit: m